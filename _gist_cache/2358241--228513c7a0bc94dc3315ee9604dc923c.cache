@sockets = []
EventMachine.run do
  connection = AMQP.connect(:host => "localhost", 
                            :user => "guest", 
                            :password => "guest", 
                            :vhost => "/", 
                            :logging => true, 
                            :port => 5672
                            )

  EventMachine::WebSocket.start(:host => '127.0.0.1', :port => 61615) do |ws|
    socket_detail = {:socket => ws}
    
    ws.onopen do
      @sockets << socket_detail
      puts " SOCKET INFO #{socket_detail.inspect}"
    end

    ws.onmessage do |message|
      puts "received message : #{message}"
      
      publish(message, "leads", ws)
    end